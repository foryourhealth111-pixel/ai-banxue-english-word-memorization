# 安卓悬浮窗单词讲解助手设计方案

日期: 2026-02-26  
状态: 设计草案（可直接进入 MVP 开发）

## 1. 目标与约束

### 1.1 核心目标
- 用户在背单词 App 界面中点击悬浮窗按钮。
- App 自动截图并识别“当前正在记忆且视觉上最大的英文单词”。
- 将截图信息和教学提示发送给 AI，返回便于记忆的讲解（巧记 + 词源）。
- 结果在悬浮窗中展示，并支持一键复制。

### 1.2 非目标（MVP 阶段先不做）
- 不做完整词典 App。
- 不做复杂社交/打卡系统。
- 不做多模型自动切换和复杂计费系统。

### 1.3 关键约束
- Android 对悬浮窗、录屏/截图权限限制严格。
- API Key 不能硬编码在客户端（会被反编译泄漏）。
- 用户可能在隐私界面使用，需要最小化数据上传。

## 2. 方案对比（2-3 个路径）

### 方案 A：本地 OCR + 云端讲解（推荐）
- 流程: 截图 -> 本地 OCR 筛词 -> 上传“目标词 + 可选小图”给 AI -> 返回讲解。
- 优点:
  - 快，省 token，稳定。
  - 隐私更好（默认只上传单词，不传整图）。
  - 可做本地缓存（同词秒开）。
- 缺点:
  - OCR 规则需调优（避免误选 UI 文本）。

### 方案 B：整图直接发多模态模型
- 流程: 截图 -> 整图发模型 -> 模型自己识别并讲解。
- 优点:
  - 研发简单，首版快。
- 缺点:
  - 成本高，时延高。
  - 误识别风险更大，调试不透明。

### 方案 C：Accessibility 抓文本 + AI 讲解
- 流程: 读无障碍节点文本 -> 选词 -> AI 讲解。
- 优点:
  - 不用 MediaProjection 截图流程。
- 缺点:
  - 对第三方 App 适配不稳定，很多界面拿不到有效文本。
  - 无障碍权限用户敏感度高。

### 结论
- MVP 采用 **方案 A**。
- 增加“低置信度回退”: OCR 置信度低时，上传裁剪图（不是整图）给模型二次确认。

## 3. 目标产品体验

1. 首次安装引导用户授予:
   - 悬浮窗权限
   - 截图权限（MediaProjection）
   - 通知权限（Android 13+，前台服务通知）
2. 用户打开背单词 App。
3. 点击悬浮按钮（悬浮球）:
   - 200-500ms 完成本地 OCR 并选出目标单词。
   - 1-3s 返回 AI 讲解。
4. 悬浮卡片展示:
   - 单词
   - 巧记法（联想/拆解/场景）
   - 词源（前缀后缀/词根演化）
   - 1-2 条示例
5. 用户点“复制”将结果写入剪贴板。

## 4. 技术架构

### 4.1 技术栈
- 语言: Kotlin
- UI: Jetpack Compose
- 架构: Clean-ish（UI/Domain/Data）+ MVVM
- 并发: Kotlin Coroutines
- 网络: Retrofit + OkHttp
- OCR: Google ML Kit Text Recognition (Latin)
- 本地存储: Room（缓存讲解）+ DataStore（设置）
- DI: Hilt（可选，但推荐）

### 4.2 模块划分
- `app`: 启动、权限引导、设置页
- `feature-overlay`: 悬浮球与结果卡片 UI
- `feature-capture`: MediaProjection 截图
- `feature-ocr`: 文本识别与目标词选择
- `feature-coach`: Prompt 构建、AI 调用、结果解析
- `core-network`: API 客户端
- `core-storage`: 缓存与日志

### 4.3 核心组件
- `FloatingCoachService`:
  - 前台服务，持有悬浮窗与点击事件。
- `CaptureCoordinator`:
  - 管理 MediaProjection 生命周期，生成位图。
- `WordExtractor`:
  - OCR + 规则评分，输出目标词及置信度。
- `CoachRepository`:
  - 处理 prompt、请求 API、结果缓存与回退策略。
- `OverlayViewModel`:
  - 管理 UI 状态（Idle/Loading/Success/Error）。

## 5. 单词识别策略（避免误导）

### 5.1 候选过滤
- 只保留英文词: `^[A-Za-z-]{2,25}$`
- 去掉纯功能词和噪声（如 `OK`, `VIP`, `MENU` 等可维护停用词表）
- 去掉超短词（长度 < 3，除非在高频单词白名单）

### 5.2 评分函数（选“最大且最可能是目标词”）
- `score = areaWeight * bboxArea + centerWeight * centerProximity + wordWeight * vocabLikelihood + confidenceWeight * ocrConfidence`
- 默认权重建议:
  - `bboxArea` 0.50
  - `centerProximity` 0.20
  - `vocabLikelihood` 0.20
  - `ocrConfidence` 0.10

### 5.3 回退策略
- 若 top1 与 top2 分数差 < 阈值:
  - UI 展示 2 个候选词供用户一键选择（不增加太多操作）。
- OCR 失败:
  - 直接调用多模态回退（上传裁剪图或整图，受用户设置控制）。

## 6. AI Prompt 与输出约束

系统提示（建议固定模板）:

```text
你是英语单词记忆教练。目标是帮助用户快速记住给定单词。
请严格输出中文，结构如下：
1) 单词与音节拆分
2) 巧记法（2-3条，具体可视化联想）
3) 词源学讲解（词根/词缀/演化）
4) 1句高频例句 + 中文释义
5) 记忆复习提示（24小时内怎么复习）
控制在220字以内，避免空话。
```

用户提示（模板）:

```text
识别图片中的最大的、用户正在记忆的单词（不要被其他信息误导）。
目标词候选：{extracted_word}
若候选不准，请你自行纠正后再讲解。
```

## 7. API 接入设计（重点安全）

你提供的配置:
- Base URL: `https://right.codes/gemini`
- Model: `gemini-3-pro-preview`

### 7.1 强安全建议（必须）
- **不要把真实 API Key 写在 APK 内**。
- 建议改为:
  - App -> 你自己的轻量后端 -> `right.codes/gemini`
  - 后端保存 key，App 只拿短期 token 或直接走你后端代理。

### 7.2 若你坚持前端直连（不推荐）
- 使用 Android Keystore + 混淆 + 证书绑定（仅提高门槛，不能根治泄漏）。
- 需要准备 key 轮换机制。

## 8. 悬浮窗交互与复制设计

### 8.1 悬浮窗 UI
- 悬浮球（默认折叠）
- 点击后展开底部小卡片:
  - 标题: `Word Coach`
  - 内容区: AI 讲解（可滚动）
  - 操作区:
    - `复制`
    - `重试`
    - `关闭`

### 8.2 快捷复制
- 使用 `ClipboardManager` 写入整段讲解文本。
- 成功后 Toast: `已复制讲解内容`。

## 9. Android 权限与系统兼容

需要权限（按需）:
- `SYSTEM_ALERT_WINDOW`
- `FOREGROUND_SERVICE`
- `INTERNET`
- `POST_NOTIFICATIONS` (Android 13+)
- Android 14+ 额外关注前台服务类型与 MediaProjection 约束

兼容提示:
- 部分 App 或页面有 `FLAG_SECURE`，截图会黑屏，这是系统限制。

## 10. 错误处理与可观测性

错误分类:
- 权限未授予
- 截图失败
- OCR 无结果
- 网络失败/超时
- 模型返回格式异常

每类错误都需要:
- 用户可理解文案
- 快速重试路径
- 本地日志埋点（不记录敏感原图，默认只记词与错误码）

## 11. MVP 开发里程碑（建议 2 周）

### 第 1 周
- Day 1-2: 基础工程 + 权限引导 + 悬浮球
- Day 3-4: 截图流程 + OCR + 目标词筛选
- Day 5: API 调用 + 结果展示 + 复制功能

### 第 2 周
- Day 6-7: 错误处理 + 缓存 + 回退策略
- Day 8-9: 性能优化（时延、内存、失败率）
- Day 10: 小范围真机测试与修复

## 12. 验收标准（MVP）

- 点击悬浮球后 3 秒内拿到讲解（P50）。
- 目标词识别准确率 >= 85%（在主流背单词 App 样本集）。
- 复制成功率 >= 99%。
- 崩溃率 < 0.5%（内测样本）。

## 13. 建议的下一步

1. 先确认是否接受“后端代理 key”的安全方案。  
2. 确认是否允许“低置信度时显示2个候选词”。  
3. 确认后即可进入任务拆解与代码骨架生成（MVP）。  
